# 部署postgres
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: adp-service-env
  namespace: devops
data:
  SERVER_PORT: '8080'
  EVENT_SOURCE_PORT: '8081'

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: adp
  namespace: devops
  labels:
    k8s-app: adp
spec:
  replicas: 2
  selector:
    matchLabels:
      k8s-app: adp
  template:
    metadata:
      labels:
        k8s-app: adp
    spec:
      imagePullSecrets:
        - name: regsecret
      containers:
        - image: docker.dm-ai.cn/devops/adp-service:0.1.0
          name: adp-service
          envFrom:
            - configMapRef:
                name: adp-service-env
          ports:
            - containerPort: 8080
              name: backend-service
            - containerPort: 8081
              name: event-source
          resources:
            limits:
              cpu: 500m
              memory: 1000Mi
            requests:
              cpu: 500m
              memory: 1000Mi
          readinessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 40
            failureThreshold: 40
          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
        - image: docker.dm-ai.cn/devops/adp-frontend:0.1.0
          name: adp-frontend
          ports:
            - containerPort: 80
          resources:
            limits:
              cpu: 500m
              memory: 1000Mi
            requests:
              cpu: 500m
              memory: 1000Mi
---
apiVersion: v1
kind: Service
metadata:
  name: adp
  namespace: devops
spec:
  type: ClusterIP
  selector:
    k8s-app: adp
  ports:
    - port: 80
      targetPort: 80
      name: adp-frontend
    - port: 8080
      targetPort: 8080
      name: adp-service
    - port: 8081
      targetPort: 8081
      name: adp-event-source

---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: adp
  namespace: devops
spec:
  routes:
    - match: Host(`adp-new-frontend.devops.dev.dm-ai.cn`)
      kind: Rule
      services:
        - name: adp
          port: 80
    - match: Host(`adp-new-backend.devops.dev.dm-ai.cn`)
      kind: Rule
      services:
        - name: adp
          port: 8080
